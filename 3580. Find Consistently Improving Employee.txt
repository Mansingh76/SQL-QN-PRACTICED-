3580. Find Consistently Improving Employees


WITH cte AS
(
    SELECT T1.employee_id, T1.name, T2.review_date, T2.rating FROM employees AS T1
INNER JOIN
performance_reviews AS T2
ON T1.employee_id = T2.employee_id
INNER JOIN
(SELECT employee_id FROM performance_reviews GROUP BY employee_id HAVING COUNT(*) >= 3) AS T3
ON T2.employee_id = T3.employee_id
),
cte2 AS (
SELECT DISTINCT employee_id, name,
NTH_VALUE(rating, 3) OVER(PARTITION BY employee_id ORDER BY review_date DESC) AS `first_score`,
NTH_VALUE(rating, 2) OVER(PARTITION BY employee_id ORDER BY review_date DESC) AS `second_score`,
NTH_VALUE(rating, 1) OVER(PARTITION BY employee_id ORDER BY review_date DESC) AS `third_score`
FROM cte
)
SELECT employee_id, name, (third_score - first_score) AS `improvement_score` FROM cte2 WHERE first_score IS NOT NULL AND second_score IS NOT NULL AND third_score IS NOT NULL AND (third_score - first_score) > 0
AND first_score < second_score AND second_score < third_score
ORDER BY (third_score - first_score) DESC, name